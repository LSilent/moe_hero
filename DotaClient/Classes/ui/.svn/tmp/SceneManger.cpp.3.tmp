#include "./ui/SceneManger.h"
#include "AppMacros.h"
#include "./sound/SoundSystem.h"
#include "./ui/ui.h"
//cocos2d::CCScene*  SceneManger::sm_loginScene = X_NULL;
//cocos2d::CCScene*  SceneManger::sm_mainScene = X_NULL;
//cocos2d::CCScene*  SceneManger::sm_battleScene = X_NULL;
#include "./datapool/DataPool.h"
#include "./load/ResourceCheck.h"

IMPLEMENT_SINGLETON(SceneManger)
SceneManger::SceneManger()
{
	m_status = EM_SS_UNKNOWN;
	pDirector = X_NULL;

	for (X_INT i = 0 ;i< EM_SS_NUM;i++)
	{
		 SM_SCENE[i] = X_NULL;
	}
 
}
SceneManger::~SceneManger()
{
	
}

X_VOID		SceneManger::Initial(X_UINT width ,X_UINT height)
{
	 pDirector = cocos2d::CCDirector::sharedDirector();
	 cocos2d::CCEGLView* pEGLView = cocos2d::CCEGLView::sharedOpenGLView();
	 pDirector->setOpenGLView(pEGLView);
    
	 //pEGLView->setFrameSize(width,height);
	 //pEGLView->setDesignResolutionSize(width, height, kResolutionNoBorder);

#ifdef _WINDOWS_
	    //pEGLView->setFrameSize(768,1024);
		//pEGLView->setFrameZoomFactor(0.7);
	    pEGLView->setFrameSize(width,height);
	    pEGLView->setDesignResolutionSize(width, height, kResolutionNoBorder);

	  pDirector->setDisplayStats(true);
#else
	  pDirector->setDisplayStats(false);

#endif // _WINDOWS_
 
	  pDirector->setAnimationInterval(1.0 / 60);

	  vector<string> searchPath;
	  searchPath.push_back(ResourceURI);
	  //searchPath.push_back(ResourceUiURI);
	  searchPath.push_back(ResourceConfig);
	  searchPath.push_back(ResourceMusicURI);
	  //searchPath.push_back(ResourceCCBURI);

	  //¡Ÿ ±…Ë÷√
	  searchPath.push_back("phone/Published-iOS");
	  searchPath.push_back("phone/Published-iOS/ccbResources");
      
	//pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionNoBorder);
	cocos2d::CCSize frameSize = pEGLView->getFrameSize();

	/* if (frameSize.height > mediumResource.size.height)

	 {
         designResolutionSize = cocos2d::CCSizeMake(1280, 1920);
         pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionNoBorder);

		 searchPath.push_back(largeResource.directory);
		 //pDirector->setContentScaleFactor(MIN(largeResource.size.height/designResolutionSize.height, largeResource.size.width/designResolutionSize.width));
	 }
	 else if (frameSize.height > smallResource.size.height)
	 {
         designResolutionSize = cocos2d::CCSizeMake(1280, 1920);
         pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionNoBorder);

		 searchPath.push_back(mediumResource.directory);
		 //pDirector->setContentScaleFactor(MIN(mediumResource.size.height/designResolutionSize.height, mediumResource.size.width/designResolutionSize.width));
	 }
	 else
	 {
		 designResolutionSize = cocos2d::CCSizeMake(640, 960);
         pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionNoBorder);
         searchPath.push_back(smallResource.directory);
		 //pDirector->setContentScaleFactor(MIN(smallResource.size.height/designResolutionSize.height, smallResource.size.width/designResolutionSize.width));
	 }*/
    //designResolutionSize = cocos2d::CCSizeMake(640, 960);
   // pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionNoBorder);
    //cocos2d::CCSize _size = cocos2d::CCDirector::sharedDirector()->getWinSizeInPixels();
    
    m_resolutionType = EM_DEVICE_RESOLUTION_NORMAL;
     
    if (frameSize.height == 1136) {
        
        m_resolutionType = EM_DEVICE_RESOLUTION_640X1136;   
        designResolutionSize = cocos2d::CCSizeMake(640, 1136);
        pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionShowAll);
        
    }
	else if (frameSize.height > mediumResource.size.height)
    {
		m_resolutionType = EM_DEVICE_RESOLUTION_1536X2048;   
        designResolutionSize = cocos2d::CCSizeMake( 768, 1024);
        pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionShowAll);
    }
    else if (frameSize.height > smallResource.size.height)
    {
		m_resolutionType = EM_DEVICE_RESOLUTION_768X1024;   
        designResolutionSize = cocos2d::CCSizeMake(768,1024);
        pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionShowAll);
    }
    else
    {
		m_resolutionType = EM_DEVICE_RESOLUTION_640X960;   
        designResolutionSize = cocos2d::CCSizeMake(640, 960);
        pEGLView->setDesignResolutionSize(designResolutionSize.width, designResolutionSize.height, kResolutionShowAll);
        
    }
    
    
   searchPath.push_back(smallResource.directory);
	vector<string>::iterator iter = searchPath.begin();
	searchPath.insert(iter, ResourceCheck::GetSingleton()->getResPath());
	cocos2d::CCFileUtils::sharedFileUtils()->setSearchPaths(searchPath);
 
 
}
X_VOID		SceneManger::Tick(X_UINT nTime)
{

}
X_VOID		SceneManger::Release()
{
	for (X_INT i = 0 ;i< EM_SS_NUM;i++)
	{
		SM_SCENE[i] = X_NULL;
	}
	pDirector = X_NULL;
}
cocos2d::CCScene * SceneManger::__getScene(SCENE_STATUS ss)
{
	if(ss <= EM_SS_UNKNOWN || ss >=EM_SS_NUM) return X_NULL;
	cocos2d::CCScene * pScene = X_NULL;//SM_SCENE[ss];
	 if(pScene == X_NULL)
	 {
		 pScene = cocos2d::CCScene::create();
		 //pScene->retain();
		 SM_SCENE[ss] = pScene;
	 }
	 return pScene;
}
cocos2d::CCScene* SceneManger::GetCurrentScene()
{ 
	return GetScene(m_status);
}
cocos2d::CCScene* SceneManger::GetScene(SCENE_STATUS ss)
{
	if(ss < EM_SS_LOGIN || m_status >=EM_SS_NUM) return X_NULL;
	return SM_SCENE[ss] ;
}
 
X_VOID	SceneManger::EnterScene(SCENE_STATUS ss)
{
	if(m_status < EM_SS_UNKNOWN || m_status >= EM_SS_NUM) return ;
	//if(m_status == ss) return;
	cocos2d::CCScene * pScene = __getScene(ss);
	static bool bFirst = true;
	if (bFirst)
	{
		CCTextureCache::sharedTextureCache()->removeAllTextures(); 
		 
		pDirector->runWithScene(pScene);
		bFirst = false;
	}else
	{
		CCTextureCache::sharedTextureCache()->removeAllTextures(); 
		pDirector->replaceScene(pScene);
	}
	
	m_status = ss;
	__playSceneMusic();
}
X_VOID	SceneManger::__playSceneMusic()
{
	switch (m_status)
	{
	case SceneManger::EM_SS_UNKNOWN:
		break;
	case SceneManger::EM_SS_LOGIN:
		{
			//SoundSystem::GetSingleton()->playBackgroundMusic(("login" +SOUND_EXT).c_str());
		}
		break;
	case SceneManger::EM_SS_MAIN:
		{
			SoundSystem::GetSingleton()->playBackgroundMusic(("back" +SOUND_EXT).c_str());
		}
		break;
	case SceneManger::EM_SS_BATTLE:
		{
			SoundSystem::GetSingleton()->playBackgroundMusic(("battle" +SOUND_EXT).c_str());
		}
		break;
	case SceneManger::EM_SS_NUM:
		break;
	default:
		break;
	}
}
X_VOID			SceneManger::playGameIntroduce()
{
	 SoundSystem::GetSingleton()->pauseBackgroundMusic(true);
     SoundSystem::GetSingleton()->playBackgroundMusic(("gamein" + SOUND_EXT).c_str());
    
}
X_VOID	SceneManger::AddChildToScene(cocos2d::CCNode * child,bool onlyZorder)
{
	if(!child)return;
	cocos2d::CCScene * pScene = GetCurrentScene();
	if (!pScene) return;

	pScene->addChild(child);
	return;
	static X_ULLONG zorder = 0;

	if (child->getParent())
	{
		if (child->getParent() == pScene)
		{
			 child->setZOrder(zorder);
		}else
		{
			//error--------------------
		}
	}else
	{
		pScene->addChild(child,zorder++);
	}
	
	
	 
}
X_VOID	SceneManger::RemoveChildFormScene(cocos2d::CCNode * child,bool cleanup)
{
	if(!child)return;
	if (child->getParent())
	{
		child->getParent()->removeChild(child);
	}
}

X_VOID	SceneManger::EndGame()
{
	pDirector->end();
#if (CC_TARGET_PLATFORM == CC_PLATFORM_IOS)
	exit(0);
#endif
}